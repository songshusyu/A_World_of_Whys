<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢åŠŸèƒ½æµ‹è¯• - ä¿®å¤ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .module-card { margin-bottom: 1rem; }
        .loading-spinner { text-align: center; padding: 2rem; }
        .server-status { position: fixed; top: 10px; right: 10px; z-index: 1000; min-width: 200px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ§ª æœç´¢åŠŸèƒ½æµ‹è¯• - ä¿®å¤ç‰ˆ</h2>
            <div id="serverStatus" class="server-status">
                <div class="alert alert-info mb-0 p-2">
                    ğŸ”„ æ£€æŸ¥ä¸­...
                </div>
            </div>
        </div>
        
        <!-- æœç´¢åŒºåŸŸ -->
        <div class="row mb-4">
            <div class="col-md-10">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="è¾“å…¥æœç´¢å…³é”®è¯" value="å¦‚ä½•åˆ›ä½œä¸€é¦–éŸ³ä¹">
                    <button class="btn btn-primary" id="searchBtn">ğŸ” æœç´¢</button>
                    <button class="btn btn-secondary" id="mockBtn">ğŸ­ æ¨¡æ‹Ÿæ•°æ®</button>
                </div>
                <small class="text-muted">
                    ğŸ’¡ å°è¯•æœç´¢ï¼šå¦‚ä½•åˆ›ä½œä¸€é¦–éŸ³ä¹ã€äººå·¥æ™ºèƒ½ã€Pythonç¼–ç¨‹ã€å©šå§»æ³•
                </small>
            </div>
        </div>

        <!-- æœç´¢ç»“æœ -->
        <div id="searchResults"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class SearchTesterFixed {
            constructor() {
                this.apiBaseUrl = 'http://localhost:8081/api';  // ä½¿ç”¨8081ç«¯å£
                this.isBackendConnected = false;
                this.init();
            }

            init() {
                // ç»‘å®šæœç´¢äº‹ä»¶
                document.getElementById('searchBtn').addEventListener('click', () => {
                    const keyword = document.getElementById('searchInput').value;
                    this.testSearch(keyword);
                });

                // ç»‘å®šæ¨¡æ‹Ÿæ•°æ®äº‹ä»¶
                document.getElementById('mockBtn').addEventListener('click', () => {
                    const keyword = document.getElementById('searchInput').value || 'å¦‚ä½•åˆ›ä½œä¸€é¦–éŸ³ä¹';
                    this.showMockData(keyword);
                });

                // å›è½¦æœç´¢
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const keyword = e.target.value;
                        this.testSearch(keyword);
                    }
                });

                // æµ‹è¯•åç«¯è¿æ¥
                this.checkBackendConnection();
                
                // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡è¿æ¥
                setInterval(() => this.checkBackendConnection(), 30000);
            }

            async checkBackendConnection() {
                const statusEl = document.getElementById('serverStatus');
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/search/trending`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        signal: AbortSignal.timeout(5000)  // 5ç§’è¶…æ—¶
                    });

                    if (response.ok) {
                        this.isBackendConnected = true;
                        statusEl.innerHTML = `
                            <div class="alert alert-success mb-0 p-2">
                                âœ… åç«¯å·²è¿æ¥ (8081)
                            </div>
                        `;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    this.isBackendConnected = false;
                    statusEl.innerHTML = `
                        <div class="alert alert-warning mb-0 p-2">
                            âš ï¸ åç«¯æœªè¿æ¥
                            <small class="d-block">ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®</small>
                        </div>
                    `;
                }
            }

            async testSearch(keyword) {
                if (!keyword.trim()) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                    return;
                }

                const resultsEl = document.getElementById('searchResults');
                this.showLoading(`æ­£åœ¨æœç´¢"${keyword}"...`);

                if (!this.isBackendConnected) {
                    // å¦‚æœåç«¯æœªè¿æ¥ï¼Œç›´æ¥æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
                    setTimeout(() => this.showMockData(keyword), 1000);
                    return;
                }

                try {
                    const response = await fetch(
                        `${this.apiBaseUrl}/search/modules?keyword=${encodeURIComponent(keyword)}&page=0&size=6`,
                        {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' },
                            signal: AbortSignal.timeout(10000)  // 10ç§’è¶…æ—¶
                        }
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        this.displayResults(result.data, keyword, 'åç«¯API');
                    } else {
                        throw new Error(result.message || 'æœç´¢å¤±è´¥');
                    }

                } catch (error) {
                    console.error('APIè°ƒç”¨å¤±è´¥:', error);
                    // APIå¤±è´¥æ—¶è‡ªåŠ¨æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
                    this.showErrorAndMock(error.message, keyword);
                }
            }

            showLoading(message) {
                const resultsEl = document.getElementById('searchResults');
                resultsEl.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">${message}</p>
                    </div>
                `;
            }

            showErrorAndMock(errorMessage, keyword) {
                const resultsEl = document.getElementById('searchResults');
                resultsEl.innerHTML = `
                    <div class="alert alert-warning">
                        <h6>âš ï¸ åç«¯APIè°ƒç”¨å¤±è´¥</h6>
                        <p class="mb-2"><small>é”™è¯¯: ${errorMessage}</small></p>
                        <p class="mb-0">æ­£åœ¨æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®ä»¥æ¼”ç¤ºåŠŸèƒ½...</p>
                    </div>
                `;
                
                setTimeout(() => this.showMockData(keyword), 1500);
            }

            displayResults(modules, keyword, source = '') {
                const resultsEl = document.getElementById('searchResults');
                
                if (!modules.length) {
                    resultsEl.innerHTML = `
                        <div class="alert alert-info">
                            <h5>ğŸ“ æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è¯¾ç¨‹</h5>
                            <p>å…³é”®è¯"${keyword}"æ²¡æœ‰åŒ¹é…çš„å­¦ä¹ æ¨¡å—</p>
                        </div>
                    `;
                    return;
                }

                const cardsHTML = modules.map(module => `
                    <div class="col-md-6 col-xl-4 mb-3">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">ğŸ“š ${module.title}</h6>
                                    <span class="badge bg-light text-dark">${this.getDifficultyLabel(module.difficulty)}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${module.description}</p>
                                <div class="mb-2">
                                    ${module.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}
                                </div>
                                <small class="text-muted">
                                    â±ï¸ ${module.estimatedTime} | 
                                    â­ ${module.rating} (${module.reviewCount}æ¡è¯„ä»·)
                                </small>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-grid">
                                    <button class="btn btn-primary btn-sm" onclick="alert('å­¦ä¹ åŠŸèƒ½æ¼”ç¤ºï¼šå¼€å§‹å­¦ä¹ ${module.title}')">
                                        â–¶ï¸ å¼€å§‹å­¦ä¹ 
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                resultsEl.innerHTML = `
                    <div class="alert alert-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">âœ… æœç´¢æˆåŠŸï¼</h5>
                                <p class="mb-0">æ‰¾åˆ° <strong>${modules.length}</strong> ä¸ªå…³äº"${keyword}"çš„è¯¾ç¨‹</p>
                            </div>
                            ${source ? `<small class="text-muted">æ•°æ®æ¥æº: ${source}</small>` : ''}
                        </div>
                    </div>
                    <div class="row">
                        ${cardsHTML}
                    </div>
                `;
            }

            getDifficultyLabel(difficulty) {
                const labels = {
                    'beginner': 'åˆçº§',
                    'intermediate': 'ä¸­çº§', 
                    'advanced': 'é«˜çº§'
                };
                return labels[difficulty] || difficulty;
            }

            showMockData(keyword = 'å¦‚ä½•åˆ›ä½œä¸€é¦–éŸ³ä¹') {
                // æ ¹æ®å…³é”®è¯ç”Ÿæˆä¸åŒçš„æ¨¡æ‹Ÿæ•°æ®
                let mockModules = [];
                
                if (keyword.includes('éŸ³ä¹') || keyword.includes('åˆ›ä½œ')) {
                    mockModules = [
                        {
                            moduleId: 'music-theory-basics',
                            title: 'éŸ³ä¹ç†è®ºåŸºç¡€',
                            description: 'å­¦ä¹ éŸ³ç¬¦ã€å’Œå¼¦ã€èŠ‚å¥ç­‰åŸºç¡€çŸ¥è¯†ï¼Œå¥ å®šéŸ³ä¹åˆ›ä½œåŸºç¡€ã€‚',
                            difficulty: 'beginner',
                            estimatedTime: '3å°æ—¶',
                            tags: ['éŸ³ä¹ç†è®º', 'åŸºç¡€', 'å…¥é—¨'],
                            rating: 4.8,
                            reviewCount: 156
                        },
                        {
                            moduleId: 'creative-inspiration',
                            title: 'åˆ›ä½œçµæ„Ÿä¸æ„æ€',
                            description: 'æ¿€å‘åˆ›ä½œçµæ„Ÿï¼Œæ„å»ºæ—‹å¾‹å’Œå’Œå¼¦è¿›è¡Œï¼Œå½¢æˆéŸ³ä¹ä¸»é¢˜ã€‚',
                            difficulty: 'intermediate',
                            estimatedTime: '2.5å°æ—¶',
                            tags: ['åˆ›ä½œ', 'çµæ„Ÿ', 'æ—‹å¾‹'],
                            rating: 4.6,
                            reviewCount: 124
                        },
                        {
                            moduleId: 'composition-techniques',
                            title: 'ç¼–æ›²ä¸ä¹å™¨è¿ç”¨',
                            description: 'æŒæ¡ç¼–æ›²æŠ€å·§ï¼Œå­¦ä¹ ä¹å™¨éŸ³è‰²ä¸æ­é…ï¼Œä¸°å¯ŒéŸ³ä¹ä½œå“ã€‚',
                            difficulty: 'intermediate',
                            estimatedTime: '4å°æ—¶',
                            tags: ['ç¼–æ›²', 'ä¹å™¨', 'éŸ³è‰²'],
                            rating: 4.7,
                            reviewCount: 98
                        },
                        {
                            moduleId: 'recording-production',
                            title: 'å½•éŸ³ä¸åæœŸåˆ¶ä½œ',
                            description: 'äº†è§£å½•éŸ³æŠ€æœ¯ï¼Œå­¦ä¹ éŸ³é¢‘ç¼–è¾‘ä¸æ··éŸ³ï¼Œå®ŒæˆéŸ³ä¹ä½œå“ã€‚',
                            difficulty: 'advanced',
                            estimatedTime: '5å°æ—¶',
                            tags: ['å½•éŸ³', 'åæœŸ', 'æ··éŸ³'],
                            rating: 4.5,
                            reviewCount: 87
                        }
                    ];
                } else if (keyword.includes('äººå·¥æ™ºèƒ½') || keyword.includes('AI') || keyword.includes('æ™ºèƒ½')) {
                    mockModules = [
                        {
                            moduleId: 'ai-fundamentals',
                            title: 'äººå·¥æ™ºèƒ½åŸºç¡€',
                            description: 'å…¨é¢äº†è§£äººå·¥æ™ºèƒ½çš„å‘å±•å†ç¨‹ã€æ ¸å¿ƒæ¦‚å¿µå’Œä¸»è¦åº”ç”¨é¢†åŸŸã€‚',
                            difficulty: 'beginner',
                            estimatedTime: '4å°æ—¶',
                            tags: ['äººå·¥æ™ºèƒ½', 'æœºå™¨å­¦ä¹ ', 'æŠ€æœ¯'],
                            rating: 4.9,
                            reviewCount: 234
                        },
                        {
                            moduleId: 'machine-learning-intro',
                            title: 'æœºå™¨å­¦ä¹ å…¥é—¨',
                            description: 'æœºå™¨å­¦ä¹ çš„åŸºæœ¬æ¦‚å¿µã€ç®—æ³•åˆ†ç±»å’Œå®é™…åº”ç”¨æ¡ˆä¾‹ã€‚',
                            difficulty: 'intermediate',
                            estimatedTime: '6å°æ—¶',
                            tags: ['æœºå™¨å­¦ä¹ ', 'ç®—æ³•', 'æ•°æ®ç§‘å­¦'],
                            rating: 4.7,
                            reviewCount: 178
                        },
                        {
                            moduleId: 'deep-learning-basics',
                            title: 'æ·±åº¦å­¦ä¹ åŸºç¡€',
                            description: 'ç¥ç»ç½‘ç»œçš„å·¥ä½œåŸç†ã€æ·±åº¦å­¦ä¹ æ¡†æ¶ä½¿ç”¨å’Œé¡¹ç›®åº”ç”¨ã€‚',
                            difficulty: 'advanced',
                            estimatedTime: '8å°æ—¶',
                            tags: ['æ·±åº¦å­¦ä¹ ', 'ç¥ç»ç½‘ç»œ', 'AI'],
                            rating: 4.8,
                            reviewCount: 145
                        }
                    ];
                } else {
                    // é€šç”¨æ¨¡å—
                    mockModules = [
                        {
                            moduleId: 'general-basic',
                            title: `${keyword}åŸºç¡€æ•™ç¨‹`,
                            description: `å…³äº${keyword}çš„åŸºç¡€çŸ¥è¯†å’Œæ ¸å¿ƒæ¦‚å¿µï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿå…¥é—¨ã€‚`,
                            difficulty: 'beginner',
                            estimatedTime: '3å°æ—¶',
                            tags: [keyword, 'åŸºç¡€', 'å…¥é—¨'],
                            rating: 4.0,
                            reviewCount: 50
                        },
                        {
                            moduleId: 'general-advanced',
                            title: `${keyword}æ·±åº¦è§£æ`,
                            description: `æ·±å…¥æ¢è®¨${keyword}çš„é«˜çº§åº”ç”¨å’Œå®è·µæ¡ˆä¾‹ï¼Œæå‡ä¸“ä¸šæŠ€èƒ½ã€‚`,
                            difficulty: 'intermediate',
                            estimatedTime: '4å°æ—¶',
                            tags: [keyword, 'é«˜çº§', 'å®è·µ'],
                            rating: 4.2,
                            reviewCount: 75
                        }
                    ];
                }

                this.displayResults(mockModules, keyword, 'å‰ç«¯æ¨¡æ‹Ÿæ•°æ®');
                
                // æ·»åŠ æ¨¡æ‹Ÿæ•°æ®è¯´æ˜
                const resultsEl = document.getElementById('searchResults');
                resultsEl.insertAdjacentHTML('afterbegin', `
                    <div class="alert alert-info">
                        <h6>ğŸ­ æ¨¡æ‹Ÿæ•°æ®æ¼”ç¤º</h6>
                        <p class="mb-0">è¿™æ˜¯å‰ç«¯ç”Ÿæˆçš„æ¨¡æ‹Ÿæ•°æ®ï¼Œå±•ç¤ºæœç´¢åŠŸèƒ½çš„æ•ˆæœã€‚å½“åç«¯æœåŠ¡å™¨è¿æ¥æ­£å¸¸æ—¶ï¼Œå°†æ˜¾ç¤ºçœŸå®çš„APIæ•°æ®ã€‚</p>
                    </div>
                `);
            }
        }

        // åˆå§‹åŒ–æµ‹è¯•å™¨
        const searchTester = new SearchTesterFixed();
        
        // æ·»åŠ å…¨å±€å‡½æ•°ç”¨äºè°ƒè¯•
        window.testConnection = () => searchTester.checkBackendConnection();
        window.testSearch = (keyword) => searchTester.testSearch(keyword);
    </script>
</body>
</html> 